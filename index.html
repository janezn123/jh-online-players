<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JH | Online Players</title>

    <style>
        :root {
            --bg: #020617;
            --panel: #0f172a;
            --border: #1e293b;
            --muted: #94a3b8;
            --text: #e5e7eb;
            --text-strong: #f8fafc;
            --accent: #93c5fd;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            background:
                radial-gradient(900px 400px at 20% -10%, rgba(147, 197, 253, .18), transparent 60%),
                radial-gradient(900px 400px at 90% 0%, rgba(96, 165, 250, .14), transparent 55%),
                var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .wrap {
            max-width: 900px;
            margin: 20px auto;
            padding: 0 16px;
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, .35);
            overflow: hidden;
        }

        header {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            background: rgba(2, 6, 23, .35);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            font-size: 20px;
            color: var(--text-strong);
        }

        .menu-container {
            position: relative;
        }

        .hamburger {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border-radius: 6px;
            transition: background .15s ease;
        }

        .hamburger:hover {
            background: rgba(147, 197, 253, .15);
        }

        .hamburger span {
            display: block;
            width: 24px;
            height: 2px;
            background: var(--text);
            border-radius: 2px;
            transition: all .2s ease;
        }

        .menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, .4);
            min-width: 200px;
            padding: 8px 0;
            display: none;
            z-index: 100;
        }

        .menu-dropdown.show {
            display: block;
        }

        .menu-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background .15s ease;
            user-select: none;
        }

        .menu-item:hover {
            background: rgba(147, 197, 253, .1);
        }

        .menu-label {
            font-size: 14px;
            color: var(--text);
        }

        .menu-status {
            font-size: 12px;
            color: var(--muted);
            margin-left: 12px;
        }

        .menu-status.enabled {
            color: #22c55e;
        }

        /* Toggle switch */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: background .2s ease;
        }

        .toggle-switch.enabled {
            background: rgba(34, 197, 94, .4);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--text);
            border-radius: 50%;
            transition: transform .2s ease;
        }

        .toggle-switch.enabled::after {
            transform: translateX(20px);
            background: #22c55e;
        }

        .refresh-info {
            padding: 8px 16px;
            font-size: 12px;
            color: var(--muted);
            border-top: 1px solid var(--border);
            margin-top: 4px;
            display: none;
        }

        .refresh-info.visible {
            display: block;
        }

        .refresh-input-group {
            padding: 8px 16px;
            display: none;
            align-items: center;
            gap: 8px;
            border-top: 1px solid var(--border);
            margin-top: 4px;
        }

        .refresh-input-group.visible {
            display: flex;
        }

        .refresh-input {
            width: 70px;
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: rgba(2, 6, 23, .3);
            color: var(--text);
            font-size: 13px;
            font-family: inherit;
        }

        .refresh-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .refresh-input-label {
            font-size: 13px;
            color: var(--muted);
        }

        .table-wrap {
            overflow-x: auto;
        }

        .server-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .server-table thead {
            background: rgba(2, 6, 23, .55);
            position: sticky;
            top: 0;
        }

        .server-table th {
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: .04em;
            color: var(--muted);
            border-bottom: 1px solid var(--border);
        }

        .details-col {
            padding-right: 14px;
        }

        .server-table th:nth-child(1) {
            padding: 6px 0px 6px 14px;
        }

        .server-table td:nth-child(1) {
            padding: 6px 0px 6px 14px;
        }

        .server-table td {
            padding: 6px 0px;
            border-top: 1px solid var(--border);
        }

        .server-table tbody tr:nth-child(even) {
            background: rgba(2, 6, 23, .25);
        }

        .server-table tbody tr:hover {
            background: rgba(2, 6, 23, .45);
        }

        .server-table td:first-child {
            color: var(--text-strong);
        }

        .server-table td:last-child {
            color: var(--accent);
        }

        .empty {
            padding: 18px;
            color: var(--muted);
            font-size: 14px;
        }

        .copy-btn {
            font-family: inherit;
            margin-left: 8px;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(147, 197, 253, .25);
            background: rgba(147, 197, 253, .12);
            color: #e5e7eb;
            cursor: pointer;
            transition: background .15s ease, border-color .15s ease;
        }

        .copy-btn:hover {
            background: rgba(147, 197, 253, .2);
            border-color: rgba(147, 197, 253, .4);
        }

        .copy-btn.copied {
            background: rgba(34, 197, 94, .25);
            border-color: rgba(34, 197, 94, .6);
            color: #bbf7d0;
        }


        .details-row td {
            padding-top: 0;
            border-top: none;
        }

        .details {
            margin: 0 14px 12px;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(2, 6, 23, .25);
            color: var(--muted);
            font-size: 14px;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
        }

        .details code {
            color: var(--text);
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
        }

        .nowrap-cell {
            white-space: nowrap;
        }

        .more-btn {
            display: none;
            align-items: center;
            padding: 4px 8px;
            /* font-size: 11px;
            font-weight: 600; */
            font-family: inherit;
            border-radius: 6px;
            border: 1px solid rgba(147, 197, 253, .25);
            background: rgba(147, 197, 253, .12);
            color: #e5e7eb;
            cursor: pointer;
        }

        .more-btn:hover {
            background: rgba(147, 197, 253, .2);
            border-color: rgba(147, 197, 253, .4);
        }

        .server-table td:nth-child(1),
        .server-table td:nth-child(2) {
            white-space: normal;
            /* allow wrapping */
            overflow-wrap: anywhere;
            /* wrap long words/names */
            word-break: break-word;
            /* fallback */
        }

        .flag {
            padding: 0px 0px 0px 8px;
        }

        @media (max-width: 640px) {
            .wrap {
                margin: 20px auto;
            }

            .server-table {
                font-size: 14px;
            }

            .ip-port {
                display: none;
            }

            .more-btn {
                display: inline-flex;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="card">
            <header>
                <h1>JumpersHeaven | Online Players</h1>
                <div class="menu-container">
                    <button class="hamburger" id="hamburgerBtn" aria-label="Menu">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <div class="menu-dropdown" id="menuDropdown">
                        <div class="menu-item" id="autoRefreshToggle">
                            <span class="menu-label">Auto Refresh</span>
                            <div class="toggle-switch" id="toggleSwitch"></div>
                        </div>
                        <div class="refresh-info" id="refreshInfo">Refresh: Off</div>
                        <div class="refresh-input-group">
                            <input type="number" id="refreshInput" class="refresh-input" value="60" min="5" max="600"
                                step="5">
                            <span class="refresh-input-label">seconds (min: 5, max: 600)</span>
                        </div>
                    </div>
                </div>
            </header>

            <div class="table-wrap">
                <table id="servers" class="server-table"></table>
                <div id="empty" class="empty" style="display:none;">
                    No COD2 players online.
                </div>
            </div>
        </div>
    </div>

    <script>
        const table = document.getElementById("servers");
        const empty = document.getElementById("empty");

        function fetchData() {
            fetch("https://jhstats.fly.dev/api/v1/tracker/online-players")
                .then(r => r.json())
                .then(({ servers }) => {
                    // flatten: one row per player
                    const rows = servers
                        .filter(s => s.game_type === "COD2" && Array.isArray(s.players))
                        .flatMap(s =>
                            s.players.map(p => ({
                                player_count: s.players.length,
                                player: removeColors(removeColors(p.playername)),
                                admin: p.admin,
                                map: s.map,
                                domain: s.domain,
                                ip: s.ip,
                                port: s.port
                            }))
                        )
                        .sort((a, b) => {
                            if (b.player_count !== a.player_count) {
                                return b.player_count - a.player_count;
                            }

                            if (a.domain !== b.domain) {
                                return a.domain.localeCompare(b.domain);
                            }

                            if (b.admin !== a.admin) {
                                return b.admin - a.admin;
                            }

                            return a.player.localeCompare(b.player);
                        });

                    if (!rows.length) {
                        empty.style.display = "block";
                        table.innerHTML = `
            <thead>
              <tr>
                <th>player</th>
                <th>map</th>
                <th class="flag">server</th>
                <th class="details-col"></th>
                <th class="ip-port">ip / port</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;
                        return;
                    }

                    table.innerHTML = `
          <thead>
            <tr>
              <th>player</th>
              <th>map</th>
              <th class="flag">server</th>
              <th class="details-col"></th>
              <th class="ip-port">ip / port</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map((r, idx) => {
                        const addr = `${escapeHtml(r.ip)}:${r.port}`;
                        return `
                <tr>
                  <td>${escapeHtml(r.player) + " (" + r.admin + ")"}</td>
                  <td>${escapeHtml(r.map)}</td>
                  <td class="country-td">
                    ${flagFromDomain(r.domain)}
                  </td>
                  <td class="details-col" style="padding-right: 10px">
                    <button class="more-btn" data-toggle="${idx}">Details</button>
                  </td>
                  <!-- Desktop shows IP/Port here; mobile hides this whole column via CSS -->
                  <td class="nowrap-cell ip-port">
                    ${addr}
                    <button
                      class="copy-btn"
                      data-copy="${addr}"
                      title="Copy server address"
                    >Copy</button>
                  </td>
                </tr>

                <!-- Mobile "details" row (hidden by default) -->
                <tr class="details-row" data-details-for="${idx}" style="display:none;">
                  <td colspan="3">
                    <div class="details">
                      <div>
                        <div style="font-size:12px; color: var(--muted); margin-bottom:4px;">IP / Port</div>
                        <code>${addr}</code>
                      </div>
                      <button
                        class="copy-btn"
                        data-copy="${addr}"
                        title="Copy server address"
                      >Copy</button>
                    </div>
                  </td>
                </tr>
              `;
                    }).join("")}
          </tbody>
        `;
                })
                .catch(err => {
                    console.error(err);
                    table.outerHTML = `<div class="empty">Failed to load players.</div>`;
                });
        }

        // Auto-refresh state
        const DEFAULT_REFRESH_INTERVAL = 60; // seconds
        const MIN_REFRESH_INTERVAL = 5;
        const MAX_REFRESH_INTERVAL = 600;
        let autoRefreshEnabled = false;
        let refreshTimerId = null;
        let refreshInterval = DEFAULT_REFRESH_INTERVAL;

        // Menu elements
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const menuDropdown = document.getElementById('menuDropdown');
        const autoRefreshToggle = document.getElementById('autoRefreshToggle');
        const toggleSwitch = document.getElementById('toggleSwitch');
        const refreshInfo = document.getElementById('refreshInfo');
        const refreshInput = document.getElementById('refreshInput');

        // Toggle menu dropdown
        hamburgerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            menuDropdown.classList.toggle('show');
        });

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!menuDropdown.contains(e.target) && !hamburgerBtn.contains(e.target)) {
                menuDropdown.classList.remove('show');
            }
        });

        // Handle custom refresh interval input
        refreshInput.addEventListener('change', () => {
            let value = parseInt(refreshInput.value, 10);
            // Clamp value between min and max
            if (isNaN(value) || value < MIN_REFRESH_INTERVAL) {
                value = MIN_REFRESH_INTERVAL;
            } else if (value > MAX_REFRESH_INTERVAL) {
                value = MAX_REFRESH_INTERVAL;
            }
            refreshInput.value = value;
            refreshInterval = value;
            // Save to localStorage
            localStorage.setItem('refreshInterval', value.toString());
            // If auto-refresh is enabled, restart with new interval
            if (autoRefreshEnabled) {
                updateAutoRefresh();
            }
        });

        // Prevent menu from closing when clicking in the input
        refreshInput.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Toggle auto-refresh
        autoRefreshToggle.addEventListener('click', () => {
            autoRefreshEnabled = !autoRefreshEnabled;
            updateAutoRefresh();
        });

        function updateAutoRefresh() {
            // Clear existing timer
            if (refreshTimerId) {
                clearInterval(refreshTimerId);
                refreshTimerId = null;
            }

            // Update UI
            if (autoRefreshEnabled) {
                toggleSwitch.classList.add('enabled');
                refreshInfo.textContent = `Refresh: Every ${refreshInterval}s`;
                refreshInfo.classList.add('visible');
                refreshInput.closest('.refresh-input-group').classList.add('visible');
                // Start new timer
                refreshTimerId = setInterval(fetchData, refreshInterval * 1000);
                // Save to localStorage
                localStorage.setItem('autoRefresh', 'true');
            } else {
                toggleSwitch.classList.remove('enabled');
                refreshInfo.textContent = 'Refresh: Off';
                refreshInfo.classList.remove('visible');
                refreshInput.closest('.refresh-input-group').classList.remove('visible');
                localStorage.setItem('autoRefresh', 'false');
            }
        }

        // Load saved preferences
        const savedAutoRefresh = localStorage.getItem('autoRefresh');
        const savedRefreshInterval = localStorage.getItem('refreshInterval');

        if (savedRefreshInterval) {
            const savedInterval = parseInt(savedRefreshInterval, 10);
            if (!isNaN(savedInterval) && savedInterval >= MIN_REFRESH_INTERVAL && savedInterval <= MAX_REFRESH_INTERVAL) {
                refreshInterval = savedInterval;
                refreshInput.value = savedInterval;
            }
        }

        if (savedAutoRefresh === 'true') {
            autoRefreshEnabled = true;
            updateAutoRefresh();
        }

        // Initial fetch
        fetchData();

        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, m => ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;"
            }[m]));
        }

        document.addEventListener("click", e => {
            // Toggle details (mobile)
            const more = e.target.closest(".more-btn");
            if (more) {
                const idx = more.getAttribute("data-toggle");
                const detailsRow = table.querySelector(`.details-row[data-details-for="${idx}"]`);
                if (detailsRow) {
                    const isOpen = detailsRow.style.display !== "none";
                    detailsRow.style.display = isOpen ? "none" : "";
                    more.textContent = isOpen ? "Details" : "Hide";
                }
                return;
            }

            // Copy
            const btn = e.target.closest(".copy-btn");
            if (!btn) return;

            const text = btn.dataset.copy;

            navigator.clipboard.writeText(text).then(() => {
                btn.classList.add("copied");
                btn.textContent = "Copied";

                setTimeout(() => {
                    btn.classList.remove("copied");
                    btn.textContent = "Copy";
                }, 1200);
            });
        });

        function removeColors(name) {
            return name.replace(/\^\d/g, "");
        }

        function getServerName(domain) {
            return domain.split(".")[0].toUpperCase();
        }

        const regionNames = new Intl.DisplayNames(["en"], { type: "region" });

        function isValidCountryCode(code) {
            if (!code || code.length !== 2) return false;
            const up = code.toUpperCase();
            return regionNames.of(up) !== up; // valid codes resolve to a country name
        }

        // Some server prefixes commonly used but not ISO-3166 alpha-2:
        function normalizeCountryCode(code) {
            const up = code.toUpperCase();
            if (up === "UK") return "GB"; // UK isn't ISO-3166 alpha-2; GB is
            if (up === "UAE") return "AE";
            return up;
        }

        function flagImgHtml(code) {
            const normalized = normalizeCountryCode(code);
            if (!isValidCountryCode(normalized)) return "";

            // flagcdn uses lowercase country codes
            const cc = normalized.toLowerCase();

            // PNG example (fast + simple). You can change size: /24x18/, /40x30/, etc.
            const url = `https://flagcdn.com/h20/${cc}.jpg`;

            return `<img class="flag" src="${url}" alt="${normalized} flag" loading="lazy">`;
        }

        function flagFromDomain(domain) {
            const key = String(domain || "").split(".")[0].toUpperCase(); // e.g. RO
            const img = flagImgHtml(key);
            return img; // already HTML
        }

        const mobileMQ = window.matchMedia("(max-width: 640px)");

        function closeDetailsIfNecessary(e) {
            if (window.innerWidth > 640) {
                // hide all details rows
                table.querySelectorAll(".details-row").forEach(row => {
                    row.style.display = "none";
                });

                // reset all "Details" buttons
                table.querySelectorAll(".more-btn").forEach(btn => {
                    btn.textContent = "Details";
                });
            }
        }

        // fire when the media query match state changes (resize/orientation/etc.)
        if (mobileMQ.addEventListener) {
            mobileMQ.addEventListener("change", closeDetailsIfNecessary);
        } else {
            // Safari fallback
            mobileMQ.addListener(closeDetailsIfNecessary);
        }

        // optional: also close on any resize (covers weird cases)
        window.addEventListener("resize", closeDetailsIfNecessary);

    </script>
</body>

</html>
